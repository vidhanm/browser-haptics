<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haptic Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.3);
            flex: 1;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 82, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(68, 160, 141, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(68, 160, 141, 0.4);
        }

        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-item {
            color: white;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-value {
            font-weight: 600;
            color: #4ecdc4;
        }

        .haptic-timeline {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .haptic-timeline h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .haptic-event {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            color: white;
            font-size: 0.9em;
        }

        .intensity-control {
            margin: 20px 0;
        }

        .intensity-control label {
            color: white;
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: none;
        }

        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Haptic Video Player</h1>
        
        <div class="warning">
            üì± For best experience, use this on a mobile device with vibration support. Desktop browsers have limited haptic feedback capabilities.
            <br><strong>Note:</strong> iPhones do not support standard web vibration APIs, but iOS 18+ provides some haptic feedback through UI interactions.
        </div>

        <div class="video-container">
            <video id="hapticVideo" controls preload="metadata" playsinline>
                <source src="./f1-video.mp4" type="video/mp4">
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <p>Your browser doesn't support HTML5 video. Here is a <a href="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4">link to the video</a> instead.</p>
            </video>
        </div>

        <div class="controls">
            <button class="btn" id="playBtn">‚ñ∂Ô∏è Play</button>
            <button class="btn secondary" id="testBtn">üîÑ Test Vibration</button>
        </div>

        <!-- Hidden iOS haptic feedback elements -->
        <div style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;">
            <input type="checkbox" id="iosHaptic1" switch>
            <label for="iosHaptic1">iOS Haptic 1</label>
            <input type="checkbox" id="iosHaptic2" switch>
            <label for="iosHaptic2">iOS Haptic 2</label>
            <input type="checkbox" id="iosHaptic3" switch>
            <label for="iosHaptic3">iOS Haptic 3</label>
        </div>

        <div class="intensity-control">
            <label for="intensitySlider">Haptic Intensity: <span id="intensityValue">100%</span></label>
            <input type="range" id="intensitySlider" class="slider" min="0" max="100" value="100">
        </div>

        <div class="status">
            <div class="status-item">
                <span>Vibration Support:</span>
                <span class="status-value" id="vibrationSupport">Checking...</span>
            </div>
            <div class="status-item">
                <span>Current Time:</span>
                <span class="status-value" id="currentTime">0:00</span>
            </div>
            <div class="status-item">
                <span>Haptic Events:</span>
                <span class="status-value" id="hapticCount">0 events loaded</span>
            </div>
        </div>

        <div class="haptic-timeline" id="hapticTimelineContainer">
            <h3>üèéÔ∏è F1 Haptic Timeline</h3>
            <!-- Timeline events will be populated by JavaScript -->
        </div>
    </div>

    <script>
        class HapticVideoPlayer {
            constructor() {
                this.video = document.getElementById('hapticVideo');
                this.playBtn = document.getElementById('playBtn');
                this.testBtn = document.getElementById('testBtn');
                this.intensitySlider = document.getElementById('intensitySlider');
                this.intensityValue = document.getElementById('intensityValue');
                this.currentTimeDisplay = document.getElementById('currentTime');
                this.hapticCountDisplay = document.getElementById('hapticCount');
                this.timelineContainer = document.getElementById('hapticTimelineContainer');
                
                this.hapticEnabled = false;
                this.intensity = 1.0;
                this.lastHapticTime = -1; // Use -1 to ensure the first event triggers
                this.backgroundHapticInterval = null; // Manages the looping RPM vibration

                // iOS haptic support
                this.iosHapticElements = [
                    document.getElementById('iosHaptic1'),
                    document.getElementById('iosHaptic2'),
                    document.getElementById('iosHaptic3')
                ];
                this.iosHapticLabels = [
                    document.querySelector('label[for="iosHaptic1"]'),
                    document.querySelector('label[for="iosHaptic2"]'),
                    document.querySelector('label[for="iosHaptic3"]')
                ];
                this.currentHapticIndex = 0;

                // Device detection
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                this.isIOSWebView = this.isIOS && window.navigator.standalone !== undefined;
                this.supportsVibrate = 'vibrate' in navigator && !this.isIOS;

                // Define different patterns for background RPM feel
                this.rpmPatterns = {
                    low: [10, 120],      // A light, infrequent pulse for low speeds/revs
                    high: [30, 60],     // A faster, more intense buzz for high speeds/straights
                    cornering: [40, 80] // A slightly rougher feel for G-force in corners
                };

                this.hapticEvents = [
                    { time: 0.5, pattern: [80, 80, 100, 70, 150, 60, 300], description: "Launch and hard acceleration" },
                    { time: 2.2, pattern: [60], description: "Upshift" },
                    { time: 3.4, pattern: [60], description: "Upshift" },
                    { time: 4.6, pattern: [60], description: "Upshift" },
                    { time: 6.0, pattern: [60], description: "Upshift" },
                    { time: 7.8, pattern: [60], description: "Upshift into top gear" },
                    { time: 15.5, pattern: [180, 80, 150, 80, 120, 80, 100], description: "Heavy braking for Turn 1" },
                    { time: 17.8, pattern: [80, 40, 80, 40, 80], description: "Riding the kerb on Turn 1 entry" },
                    { time: 19.0, pattern: [80, 40, 80], description: "Riding the kerb on Turn 2 exit" },
                    { time: 20.0, pattern: [80, 80, 120], description: "Short burst of acceleration" },
                    { time: 21.0, pattern: [70], description: "Upshift" },
                    { time: 22.5, pattern: [70], description: "Upshift" },
                    { time: 24.0, pattern: [500], description: "Sustained G-force through Curva Grande" },
                    { time: 27.5, pattern: [60], description: "Upshift" },
                    { time: 34.2, pattern: [160, 70, 130, 70, 100], description: "Hard braking for second chicane" },
                    { time: 36.5, pattern: [90, 50, 90], description: "Hitting the entry kerb at Turn 4" },
                    { time: 37.8, pattern: [90, 50, 90], description: "Hitting the exit kerb at Turn 5" },
                    { time: 39.0, pattern: [70, 70, 150], description: "Acceleration towards Lesmo 1" },
                    { time: 41.5, pattern: [100], description: "Light brake and downshift for Lesmo 1" },
                    { time: 43.0, pattern: [250], description: "Feeling the car through Lesmo 1" },
                    { time: 45.0, pattern: [80, 60, 150], description: "Short acceleration burst" },
                    { time: 46.5, pattern: [120, 80, 80], description: "Braking for Lesmo 2" },
                    { time: 48.0, pattern: [300], description: "Sustained G-force on Lesmo 2 exit" },
                    { time: 51.0, pattern: [60], description: "Upshift" },
                    { time: 53.0, pattern: [60], description: "Upshift" },
                    { time: 54.5, pattern: [40, 50, 40, 50, 40], description: "High RPM on back straight" },
                    { time: 57.0, pattern: [60], description: "Upshift" },
                    { time: 100.5, pattern: [200, 80, 150, 80, 120, 80, 100, 80, 80], description: "Heavy braking for Ascari chicane" },
                    { time: 103.0, pattern: [90, 60, 90], description: "Kerb strike on Ascari entry" },
                    { time: 104.5, pattern: [200], description: "Mid-corner load at Ascari" },
                    { time: 106.0, pattern: [90, 60, 90], description: "Kerb strike on Ascari exit" },
                    { time: 107.5, pattern: [80, 60, 120, 50, 200], description: "Full acceleration towards Parabolica" },
                    { time: 110.0, pattern: [70], description: "Upshift" },
                    { time: 112.5, pattern: [70], description: "Upshift" },
                    { time: 116.0, pattern: [150, 100, 100], description: "Braking and turning in for Parabolica" },
                    { time: 118.5, pattern: [600], description: "Long, sustained G-force through Parabolica" },
                    { time: 124.5, pattern: [80, 60, 100, 50, 150, 40, 250], description: "Final acceleration over the line" },
                    { time: 126.8, pattern: [60], description: "Final upshift" },
                    { time: 128.0, pattern: [400, 300, 200], description: "Engine and car slowing down" }
                ];
                
                this.init();
            }
            
            init() {
                this.checkVibrationSupport();
                this.setupEventListeners();
                this.updateIntensityDisplay();
                this.populateTimeline();
            }

            populateTimeline() {
                // Clear existing timeline children except the title
                while (this.timelineContainer.children.length > 1) {
                    this.timelineContainer.removeChild(this.timelineContainer.lastChild);
                }

                this.hapticEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'haptic-event';
                    const minutes = Math.floor(event.time / 60);
                    const seconds = (event.time % 60).toFixed(1);
                    eventDiv.textContent = `${minutes}:${seconds.padStart(4, '0')} - ${event.description}`;
                    this.timelineContainer.appendChild(eventDiv);
                });
                this.hapticCountDisplay.textContent = `${this.hapticEvents.length} F1 events loaded`;
            }

            startBackgroundHaptics(pattern) {
                if (this.backgroundHapticInterval) {
                    clearInterval(this.backgroundHapticInterval);
                }

                const loopVibration = () => {
                    if (this.video.paused) {
                        this.stopBackgroundHaptics();
                        return;
                    }
                    const scaledPattern = pattern.map(d => Math.round(d * this.intensity));
                    this.vibrate(scaledPattern);
                };
                
                const intervalDuration = pattern.reduce((a, b) => a + b, 0);
                if (intervalDuration > 0) {
                   this.backgroundHapticInterval = setInterval(loopVibration, intervalDuration);
                }
            }

            stopBackgroundHaptics() {
                clearInterval(this.backgroundHapticInterval);
                this.backgroundHapticInterval = null;
                
                // Stop standard vibration for non-iOS devices
                if (!this.isIOS && 'vibrate' in navigator) {
                    navigator.vibrate(0);
                }
            }
            
            checkVibrationSupport() {
                const vibrationSupport = document.getElementById('vibrationSupport');
                if (this.isIOS) {
                    // Check if we can detect iOS 18+ switch support
                    const testSwitch = document.createElement('input');
                    testSwitch.type = 'checkbox';
                    testSwitch.setAttribute('switch', '');
                    
                    if (testSwitch.hasAttribute('switch')) {
                        vibrationSupport.textContent = 'üçé iOS Haptic (Limited)';
                        vibrationSupport.style.color = '#ffb347'; // Orange for limited support
                    } else {
                        vibrationSupport.textContent = '‚ùå Not Supported (iOS)';
                        vibrationSupport.style.color = '#ff6b6b';
                    }
                } else if (this.supportsVibrate) {
                    vibrationSupport.textContent = '‚úÖ Supported';
                    vibrationSupport.style.color = '#4ecdc4';
                } else {
                    vibrationSupport.textContent = '‚ùå Not Supported';
                    vibrationSupport.style.color = '#ff6b6b';
                }
            }
            
            setupEventListeners() {
                this.playBtn.addEventListener('click', () => {
                    if (this.video.paused) {
                        this.hapticEnabled = true;  // Always enable haptics when playing
                        
                        // Handle the Promise returned by play() for mobile compatibility
                        const playPromise = this.video.play();
                        
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                // Playback started successfully
                                this.playBtn.textContent = '‚è∏Ô∏è Pause';
                                this.startBackgroundHaptics(this.rpmPatterns.low);
                            }).catch((error) => {
                                // Playback failed - reset state
                                console.log('Video playback failed:', error);
                                this.hapticEnabled = false;
                                this.playBtn.textContent = '‚ñ∂Ô∏è Play';
                                // Could show an error message to user here
                            });
                        } else {
                            // Fallback for browsers that don't support Promise-based play()
                            this.playBtn.textContent = '‚è∏Ô∏è Pause';
                            this.startBackgroundHaptics(this.rpmPatterns.low);
                        }
                    } else {
                        this.video.pause();
                    }
                });
                
                this.testBtn.addEventListener('click', () => {
                    // Test different patterns based on device capabilities
                    if (this.isIOS) {
                        // For iOS, trigger multiple haptics with visual feedback
                        this.triggerIOSHaptic();
                        setTimeout(() => this.triggerIOSHaptic(), 100);
                        setTimeout(() => this.triggerIOSHaptic(), 250);
                        this.showHapticFeedback('Testing iOS haptic feedback');
                    } else {
                        // Standard vibration pattern for other devices
                        this.vibrate([200, 100, 200, 100, 400]);
                        this.showHapticFeedback('Testing vibration');
                    }
                });
                
                this.video.addEventListener('timeupdate', () => {
                    this.updateTime();
                    if (this.hapticEnabled) {
                        this.checkHapticEvents();
                    }
                });
                
                this.video.addEventListener('ended', () => {
                    this.hapticEnabled = false;
                    this.playBtn.textContent = '‚ñ∂Ô∏è Play';
                    this.stopBackgroundHaptics();
                });
                
                this.video.addEventListener('pause', () => {
                    this.hapticEnabled = false;
                    this.playBtn.textContent = '‚ñ∂Ô∏è Play';
                    this.stopBackgroundHaptics();
                });
                
                this.intensitySlider.addEventListener('input', (e) => {
                    this.intensity = parseInt(e.target.value) / 100;
                    this.updateIntensityDisplay();
                });
            }
            
            updateIntensityDisplay() {
                const percentage = Math.round(this.intensity * 100);
                this.intensityValue.textContent = `${percentage}%`;
            }
            
            updateTime() {
                const currentTime = this.video.currentTime;
                const minutes = Math.floor(currentTime / 60);
                const seconds = Math.floor(currentTime % 60);
                this.currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            checkHapticEvents() {
                const currentTime = this.video.currentTime;
                
                this.hapticEvents.forEach(event => {
                    if (currentTime >= event.time && this.lastHapticTime < event.time) {
                        this.triggerHaptic(event);
                        this.lastHapticTime = event.time;
                    }
                });
            }
            
            triggerHaptic(event) {
                console.log(`Triggering haptic: ${event.description} at ${event.time}s`);
                
                this.stopBackgroundHaptics();

                const scaledPattern = event.pattern.map(duration => 
                    Math.round(duration * this.intensity)
                );
                
                this.vibrate(scaledPattern);
                this.showHapticFeedback(event.description);
                
                const patternDuration = scaledPattern.reduce((a, b) => a + b, 0);

                setTimeout(() => {
                    if (this.video.paused) return; // Don't restart if video has been paused

                    let nextPattern = this.rpmPatterns.low; // Default
                    if (event.description.toLowerCase().includes("acceleration") || event.description.toLowerCase().includes("straight")) {
                        nextPattern = this.rpmPatterns.high;
                    } else if (event.description.toLowerCase().includes("corner") || event.description.toLowerCase().includes("g-force")) {
                        nextPattern = this.rpmPatterns.cornering;
                    }
                    this.startBackgroundHaptics(nextPattern);
                }, patternDuration);
            }
            
            triggerIOSHaptic() {
                if (this.isIOS && this.iosHapticLabels[this.currentHapticIndex]) {
                    // Programmatically click the label to trigger iOS haptic feedback
                    this.iosHapticLabels[this.currentHapticIndex].click();
                    
                    // Cycle through haptic elements to create variation
                    this.currentHapticIndex = (this.currentHapticIndex + 1) % this.iosHapticLabels.length;
                    return true;
                }
                return false;
            }
            
            vibrate(pattern) {
                if (this.intensity <= 0) return;
                
                let hapticTriggered = false;
                
                // Try iOS haptic feedback first
                if (this.isIOS) {
                    hapticTriggered = this.triggerIOSHaptic();
                    
                    // For iOS, also provide visual feedback since haptic may be limited
                    this.showVisualFeedback();
                }
                
                // Fallback to standard vibration API for non-iOS devices
                if (!hapticTriggered && this.supportsVibrate) {
                    navigator.vibrate(pattern);
                }
                
                // If no haptic feedback is available, show enhanced visual feedback
                if (!hapticTriggered && !this.supportsVibrate) {
                    this.showVisualFeedback(true);
                }
            }
            
            showVisualFeedback(enhanced = false) {
                // Flash the video container to provide visual feedback
                const container = document.querySelector('.video-container');
                const originalStyle = container.style.cssText;
                
                if (enhanced) {
                    // More prominent visual feedback for devices without any haptic support
                    container.style.boxShadow = '0 0 30px rgba(78, 205, 196, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.2)';
                    container.style.transform = 'scale(1.02)';
                } else {
                    // Subtle visual feedback for iOS devices
                    container.style.boxShadow = '0 0 20px rgba(78, 205, 196, 0.6)';
                }
                
                setTimeout(() => {
                    container.style.cssText = originalStyle;
                }, enhanced ? 200 : 100);
            }
            
            showHapticFeedback(description) {
                const feedback = document.createElement('div');
                feedback.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(78, 205, 196, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    text-align: center;
                `;
                feedback.textContent = `‚ö° ${description}`;
                
                if (!document.querySelector('#haptic-animation-styles')) {
                    const style = document.createElement('style');
                    style.id = 'haptic-animation-styles';
                    style.textContent = `
                        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    feedback.style.animation = 'slideOut 0.3s ease forwards';
                    feedback.addEventListener('animationend', () => feedback.remove());
                }, 2000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new HapticVideoPlayer();
        });
        
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn') && 'vibrate' in navigator) {
                navigator.vibrate(50);
            }
        });
    </script>
</body>
</html>